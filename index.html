<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Team Holdings – Live On-Chain</title>
  <style>
    :root { --bg: #ffffff; --text: #000000; --th: #f0f0f0; --border: #ccc; }
    @media (prefers-color-scheme: dark) {
      :root { --bg: #1a1a1a; --text: #ffffff; --th: #2d2d2d; --border: #444; }
    }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 2rem; }
    h2 { margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; margin: 1.5rem 0; font-size: 0.95rem; }
    th, td { border: 1px solid var(--border); padding: 10px 12px; text-align: left; }
    th { background: var(--th); font-weight: 600; }
    .loading { color: #888; font-style: italic; }
    .error { color: #e74c3c; }
    .footer { margin-top: 2rem; font-size: 0.8rem; color: #666; }
    a { color: #0066cc; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h2>Live Team Holdings – <span id="ca"></span></h2>
  <div id="status" class="loading">Loading from Solana blockchain...</div>
  <table id="tbl" style="display:none;">
    <thead><tr><th>Wallet</th><th>Balance</th><th>% of Supply</th><th>USD Value</th></tr></thead>
    <tbody></tbody>
  </table>

  <div class="footer">
    Data from Solana RPC + CoinGecko • 
    <a href="https://explorer.solana.com/address/B1oEzGes1QxVZoxR3abiwAyL4jcPRF2s2ok5Yerrpump" target="_blank">View on Explorer</a>
  </div>

  <script type="module">
    import { Connection, PublicKey } from "https://cdn.jsdelivr.net/npm/@solana/web3.js@1.91.7/+esm";

    const CA = "B1oEzGes1QxVZoxR3abiwAyL4jcPRF2s2ok5Yerrpump";
    const WALLETS = [
      "CVPqDS8h6Vgtx3nHRVVZ49P5miFYLTjQiV8obtFcwmbd",
      "64U9MukooWV5ziNXx2PCmZNmktBzQoKXnKsDBLvgCQ5g",
      "4WdBom3zUF1pA3UisvVys8oM3VpDR1US72HbQf8uwYHE"
    ];

    // CORS-friendly public RPC (QuickNode – works in browsers)
    const connection = new Connection("https://api.mainnet-beta.solana.com", "confirmed");
    const tokenMint = new PublicKey(CA);

    const caSpan = document.getElementById("ca");
    const status = document.getElementById("status");
    const table = document.getElementById("tbl");
    const tbody = table.querySelector("tbody");

    caSpan.textContent = CA;

    async function getTokenSupply() {
      try {
        console.log("Fetching supply...");
        const info = await connection.getTokenSupply(tokenMint);
        console.log("Supply fetched:", info.value.uiAmount);
        return info.value.uiAmount || 0;
      } catch (err) {
        console.error("Supply error:", err);
        return 0;
      }
    }

    async function getTokenBalance(wallet) {
      try {
        console.log(`Fetching balance for ${wallet.slice(0,6)}...`);
        const walletPubkey = new PublicKey(wallet);
        const accounts = await connection.getTokenAccountsByOwner(walletPubkey, { mint: tokenMint });
        if (accounts.value.length === 0) return 0;
        const accountInfo = await connection.getTokenAccountBalance(accounts.value[0].pubkey);
        console.log(`Balance for ${wallet.slice(0,6)}... :`, accountInfo.value.uiAmount);
        return accountInfo.value.uiAmount || 0;
      } catch (err) {
        console.error(`Balance error for ${wallet}:`, err);
        return 0;
      }
    }

    async function getPrice() {
      try {
        console.log("Fetching price...");
        const res = await fetch(`https://api.coingecko.com/api/v3/simple/token_price/solana?contract_addresses=${CA}&vs_currencies=usd`);
        if (!res.ok) throw new Error("CoinGecko failed");
        const data = await res.json();
        const price = data[CA.toLowerCase()]?.usd || 0;
        console.log("Price fetched:", price);
        return price;
      } catch (err) {
        console.error("Price error:", err);
        return 0;
      }
    }

    async function load() {
      try {
        status.className = "loading";
        status.textContent = "Fetching from Solana...";

        const [supply, price] = await Promise.all([getTokenSupply(), getPrice()]);
        console.log("All data fetched - Supply:", supply, "Price:", price);

        if (!supply) {
          throw new Error("No token supply found – check CA");
        }

        const rows = [];
        for (let w of WALLETS) {
          const bal = await getTokenBalance(w);
          const pct = supply > 0 ? (bal / supply) * 100 : 0;
          const usd = bal * price;

          rows.push([
            `<a href="https://explorer.solana.com/address/${w}" target="_blank">${w.slice(0,6)}...${w.slice(-4)}</a>`,
            bal.toLocaleString(undefined, {maximumFractionDigits: 0}),
            pct.toFixed(4) + "%",
            usd > 0 ? "$" + usd.toFixed(2) : "$0.00"
          ]);
        }

        tbody.innerHTML = rows.map(r => `<tr><td>${r.join("</td><td>")}</td></tr>`).join("");
        table.style.display = "table";
        status.textContent = `Updated: ${new Date().toLocaleTimeString()} (Supply: ${supply.toLocaleString()})`;
        status.className = "";

      } catch (err) {
        console.error("Load error:", err);
        status.className = "error";
        status.textContent = `Error: ${err.message} – Showing fallback. Check console for details.`;
        // Fallback: Show table with 0s
        const rows = WALLETS.map(w => [
          `<a href="https://explorer.solana.com/address/${w}" target="_blank">${w.slice(0,6)}...${w.slice(-4)}</a>`,
          "0",
          "0.0000%",
          "$0.00"
        ]);
        tbody.innerHTML = rows.map(r => `<tr><td>${r.join("</td><td>")}</td></tr>`).join("");
        table.style.display = "table";
      }
    }

    load();
    setInterval(load, 30_000);
  </script>
</body>
</html>
